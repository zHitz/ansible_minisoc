---
  - hosts: master
    become: yes
    vars:
      portainer_manager_port: 9000  
      portainer_admin_user: admin 
      portainer_admin_password: adminpassword 
    tasks:
    - name: Set api_endpoint variable
      set_fact:
        api_endpoint: "http://{{ ansible_host }}:{{ portainer_manager_port }}/api"

    - name: Wait for container
      wait_for:
        port: "{{ portainer_manager_port }}"
        host: "{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}"
        delay: 0
        sleep: 5
        timeout: 60

    - name: Check if an Adminstator account has been created
      uri:
        url: "{{ api_endpoint }}/users/admin/check"
        method: GET
        return_content: yes
        status_code: [200, 204, 404]
      register: admin_check

    - name: Configure admin user password
      uri:
        url: "{{ api_endpoint }}/users/admin/init"
        method: POST
        return_content: yes
        body_format: json
        body: {"Username": "{{ portainer_admin_user }}", "Password": "{{ portainer_admin_password }}"}
      when: admin_check.status not in [200,204]
